<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام الإنذارات والعقوبات</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body {
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(to right, #3494E6, #EC6EAD);
      color: #495057;
    }
    .container {
      background-color: rgba(255,255,255,0.9);
      border-radius: 15px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
      padding: 40px;
      margin-top: 30px;
      margin-bottom: 30px;
    }
    h1, h2 {
      text-align: center;
      color: #fff;
      background-color: rgba(164,83,180,0.767);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 25px;
    }
    label { font-weight: bold; color: #495057; margin-bottom: 8px; }
    .form-control, .form-select {
      border-radius: 8px; border: 1px solid #ced4da; padding: 12px; font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    .form-control:focus, .form-select:focus {
      border-color: #80bdff; outline: none; box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    }
    .btn-primary {
      background-color: #007bff; border-color: #007bff; padding: 12px 25px; font-size: 1.1rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: background-color 0.3s ease;
    }
    .btn-primary:hover { background-color: #0056b3; border-color: #0056b3; }
    .btn-danger {
      padding: 12px 25px; font-size: 1.1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: background-color 0.3s ease;
    }
    .btn-danger:hover { background-color: #dc3545; }
    .alert-item { border-bottom: 1px solid #dee2e6; padding: 15px 0; transition: background-color 0.3s ease; }
    .alert-item:last-child { border-bottom: none; }
    .alert-item:hover { background-color: #f8f9fa; }
    .alert-type { font-weight: bold; }
    .warning { color: #ffc107; }
    .penalty { color: #e74c3c; }
    .success { color: #28a745; }
    #alerts-list-title { color: #fff !important; text-align: center; }
    .btn-sm { padding: 15px; }
    /* Print Styles */
    @media print {
      body { background: none; font-size: 16px; /* Increased base font size */ }
      body > *:not(.print-area) { display: none; }
      .print-area {
        display: block; padding: 30px; border: 3px solid #000; /* Increased padding and border */ margin: 15px; /* Increased margin */
        position: relative; min-height: 250px; /* Increased min-height */
      }
      h1, h2 { color: #000 !important; text-align: center; }
      .print-button, .delete-button, .btn { display: none; }
      .warning, .penalty, .success { color: #000 !important; }
      .alert-item { border-bottom: 1px solid #ccc; }
      .print-title {
        font-size: 2em; /* Reduced title font size further */ font-weight: bold; margin-bottom: 15px; /* Reduced margin-bottom to move text up */ text-align: center;
      }
      .print-alert-message {
        font-size: 1.8em; /* Increased message font size */
        line-height: 1.7; /* Adjusted line height */
        margin-bottom: 15px; /* Reduced margin-bottom to move date/signature up */
        text-align: center; /* Centered text */
      }
      .print-date {
        font-size: 1.4em; /* Increased date font size */
        line-height: 1.6; /* Adjusted line height */
        text-align: left; /* Align date to the left */
        margin-top: 40px; /* Added margin-top to create space above date */
      }
      .signature {
        /* Removed absolute positioning */
        display: block; /* Make it a block element */
        width: 250px; /* Increased width */
        text-align: center;
        font-size: 1.8em; /* Increased signature font size */
        line-height: 1.7; /* Adjusted line height */
        border: none;
        margin-top: 5px; /* Added margin-top to create space below signature text */
        margin-left: auto; /* Center the signature block */
        margin-right: auto; /* Center the signature block */
      }
      .print-title-penalty { color: red !important; }
      .print-title-warning { color: red !important; }
      .print-title-success { color: green !important; }
    }
    /* General Styles */
    .center-screen {
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      min-height: 100vh; text-align: center; padding: 20px;
    }
    #welcomeScreen .welcome-container {
      background: linear-gradient(135deg, #6a11cb, #2575fc); padding: 40px; border-radius: 15px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    .logo-img { max-width: 400px; margin-bottom: 20px; }
    .welcome-message {
      font-size: 3em; color: #fff; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); font-weight: bold;
    }
    .description {
      font-size: 1.3em; color: #fff; line-height: 1.7; margin-bottom: 40px;
      font-family: 'Amiri', serif; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    .description-box {
      border: 1px solid #ddd; padding: 30px; border-radius: 12px; background-color: rgba(0,0,0,0.3);
    }
    #app-container { display: none; }
    .btn-enter {
      background-color: #ffc107; border: none; color: #212529; padding: 15px 30px; font-size: 1.3em;
      border-radius: 10px; transition: background-color 0.3s ease, transform 0.2s ease;
      position: relative; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .btn-enter:hover { background-color: #e0a800; transform: scale(1.05); }
    .btn-enter:before {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,0.2), transparent);
      transform: translateX(-100%); transition: transform 0.4s ease;
    }
    .btn-enter:hover:before { transform: translateX(0); }
    .btn-enter:focus { outline: none; box-shadow: 0 0 0 0.2rem rgba(255,193,7,0.5); }
  </style>
  <datalist id="employeeList"></datalist>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <div id="welcomeScreen" class="center-screen">
    <div class="welcome-container">
      <img src="images/logo.png" alt="Logo" class="logo-img">
      <h1 class="welcome-message">مرحباً بك في نظام الإنذارات والعقوبات</h1>
      <div class="description-box">
        <p class="description">
          هذا النظام مصمم خصيصاً لإدارة فعالة وشفافة لعمليات الإنذار والعقوبات داخل المؤسسة. يهدف إلى تنظيم وتسهيل متابعة المخالفات والمكافآت، وضمان تطبيق عادل للوائح والقوانين.
        </p>
      </div>
      <div class="d-flex flex-wrap justify-content-center gap-4 mt-4">
        <button onclick="goToApp()" class="btn btn-enter">الدخول إلى النظام</button>
        <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#aboutModal">نبذة عن النظام</button>
        <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#settingsModal">إعدادات</button>
      </div>
    </div>
  </div>

  <div id="app-container" style="display: none">
    <div class="container">
      <h2>إضافة إنذار أو عقوبة</h2>
      <div class="mb-3">
        <label for="name" class="form-label">اسم الموظف:</label>
        <input type="text" class="form-control" id="name" list="employeeList" required>
      </div>
      <div class="mb-3">
        <label for="type" class="form-label">نوع المخالفة:</label>
        <select class="form-select" id="type">
          </select>
      </div>
      <div class="mb-3">
        <label for="reasonMode" class="form-label">اختيار نمط السبب:</label>
        <select class="form-select" id="reasonMode">
          </select>
      </div>
      <div class="mb-3" id="aiReasonBox">
        <label for="aiReason" class="form-label">سبب الإنذار (ذكاء اصطناعي/مخصص):</label>
        <input type="text" class="form-control" id="aiReason" readonly>
      </div>
      <div class="mb-3" id="manualReasonBox" style="display: none;">
        <label for="manualReason" class="form-label">سبب الإنذار (اختياري):</label>
        <textarea class="form-control" id="manualReason" rows="3"></textarea>
      </div>
      <div class="mb-3">
        <label for="typeNumber" class="form-label">رقم المخالفة (اختياري):</label>
        <input type="number" class="form-control" id="typeNumber">
      </div>
      <button id="add-btn" class="btn btn-primary"><i class="fas fa-plus"></i> إضافة</button>
      <div class="mt-3">
        <button id="showAlertsBtn" class="btn btn-outline-primary btn-lg shadow">عرض قائمة الإنذارات والعقوبات</button>
      </div>
      <div class="mt-3">
        <button id="backToMenuBtn" class="btn btn-secondary w-100">عودة إلى القائمة الرئيسية</button>
      </div>
    </div>
  </div>

  <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="successModalLabel">تمت العملية بنجاح</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
        </div>
        <div class="modal-body text-center">
          <p>تم إضافة التنبيه بنجاح!</p>
          <button id="printSuccessBtn" class="btn btn-success"><i class="fas fa-print"></i> طباعة التنبيه</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="alertsModal" tabindex="-1" aria-labelledby="alertsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="alertsModalLabel">قائمة الإنذارات والعقوبات</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <input type="text" id="modalSearchInput" class="form-control" placeholder="ابحث بالاسم">
          </div>
          <ul id="alertsModalList" class="list-unstyled">
            </ul>
          <button id="printAlertsBtn" class="btn btn-success w-100 mt-3"><i class="fas fa-print"></i> طباعة التنبيهات</button>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="aboutModalLabel">نبذة عن النظام</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
        </div>
        <div class="modal-body">
          <p>
            هذا النظام مصمم لإدارة الإنذارات والعقوبات داخل المؤسسة بطريقة سهلة وفعالة. يمكنك إضافة الإنذارات والعقوبات، تعديلها، حذفها، والبحث فيها. كما يتيح النظام طباعة التنبيهات مع نصوص مخصصة تضمن توضيح تفاصيل المخالفة أو المكافأة.
          </p>
          <p style="text-align: center; font-weight: bold;">مطور: بلال بورابعة</p>
          <p style="text-align: center; font-weight: bold;">اصدار: 1.0</p>
          <p style="text-align: center;">
            هذا نظام مُهداة إلى أخت مريم، وأهديها تعبيراً صغيراً كامتنان من إمبراطور التقنية بلال بورابعة.
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="settingsModalLabel">إعدادات النظام</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-tabs" id="settingsTab" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup" type="button" role="tab" aria-controls="backup" aria-selected="true">نسخ احتياطي</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="patterns-tab" data-bs-toggle="tab" data-bs-target="#patterns" type="button" role="tab" aria-controls="patterns" aria-selected="false">ضبط أنماط</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="violation-tab" data-bs-toggle="tab" data-bs-target="#violation" type="button" role="tab" aria-controls="violation" aria-selected="false">إدارة أنواع المخالفات</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="employees-tab" data-bs-toggle="tab" data-bs-target="#employees" type="button" role="tab" aria-controls="employees" aria-selected="false">إدارة الموظفين</button>
            </li>
          </ul>
          <div class="tab-content mt-3" id="settingsTabContent">
            <div class="tab-pane fade show active" id="backup" role="tabpanel" aria-labelledby="backup-tab">
              <button id="backupBtn" class="btn btn-primary w-100 mb-2">تنزيل نسخة احتياطية للبيانات</button>
              <button id="restoreBtn" class="btn btn-secondary w-100 mb-2">استرجاع البيانات</button>
              <input type="file" id="restoreFileInput" style="display:none" accept=".json">
            </div>
            <div class="tab-pane fade" id="patterns" role="tabpanel" aria-labelledby="patterns-tab">
              <p class="mb-3"><small>
                  ملاحظة: عند إضافة نمط جديد يمكنك إدراج كلمة <strong>name</strong> داخل نص النمط، وسيتم استبدالها تلقائيًا باسم الموظف.
                </small></p>
              <div class="mb-3">
                <label for="patternName" class="form-label">اسم النمط الجديد:</label>
                <input type="text" class="form-control" id="patternName">
              </div>
              <div class="mb-3">
                <label for="patternText" class="form-label">نص النمط:</label>
                <textarea class="form-control" id="patternText" rows="3"></textarea>
              </div>
              <button id="addPatternBtn" class="btn btn-primary w-100 mb-2">إضافة النمط</button>
              <button id="editAIRuleBtn" class="btn btn-warning w-100 mb-2">تعديل نمط الذكاء الاصطناعي</button>
              <hr>
              <div id="customPatternsList"></div>
            </div>
            <div class="tab-pane fade" id="violation" role="tabpanel" aria-labelledby="violation-tab">
              <h3 class="mb-3">إدارة أنواع المخالفات</h3>
              <div class="mb-3">
                <input type="text" id="newViolationType" class="form-control" placeholder="أدخل نوع المخالفة">
              </div>
              <button id="addViolationTypeBtn" class="btn btn-primary w-100 mb-2">إضافة</button>
              <div id="violationTypesList"></div>
            </div>
            <div class="tab-pane fade" id="employees" role="tabpanel" aria-labelledby="employees-tab">
              <h3 class="mb-3">إدارة الموظفين</h3>
              <div class="mb-3">
                <input type="text" id="newEmployeeName" class="form-control" placeholder="أدخل اسم الموظف">
              </div>
              <button id="addEmployeeBtn" class="btn btn-primary w-100 mb-2">إضافة موظف</button>
              <div id="employeeListDiv"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editAIRuleModal" tabindex="-1" aria-labelledby="editAIRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editAIRuleModalLabel">تعديل نمط الذكاء الاصطناعي</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
        </div>
        <div class="modal-body">
          <p>يمكنك تعديل نص نمط الذكاء الاصطناعي. استخدم العلامات التالية:</p>
          <ul>
            <li><strong>{name}</strong>: سيتم استبدالها باسم الموظف.</li>
            <li><strong>{violationType}</strong>: سيتم استبدالها بنوع المخالفة.</li>
          </ul>
          <div class="mb-3">
            <label for="editAIRuleText" class="form-label">نص نمط الذكاء الاصطناعي:</label>
            <textarea class="form-control" id="editAIRuleText" rows="4"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
          <button type="button" class="btn btn-primary" id="saveAIRuleChanges">حفظ</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /****************************************
     * قسم الأنماط المخصصة          *
     ****************************************/
    let customPatterns = [];
    let editingPatternId = null; // لتحديد تعديل النمط
    function loadCustomPatterns() {
      let data = localStorage.getItem("customPatterns");
      customPatterns = data ? JSON.parse(data) : [];
    }
    function saveCustomPatterns() {
      localStorage.setItem("customPatterns", JSON.stringify(customPatterns));
    }
    function updateReasonModeDropdown() {
      let dropdown = document.getElementById("reasonMode");
      dropdown.innerHTML = "";
      let optionManual = document.createElement("option");
      optionManual.value = "manual";
      optionManual.text = "✍️ نمط اختياري";
      optionManual.selected = true;
      dropdown.appendChild(optionManual);
      let optionAI = document.createElement("option");
      optionAI.value = "ai";
      optionAI.text = "🧠 نمط الذكاء الاصطناعي";
      dropdown.appendChild(optionAI);
      customPatterns.forEach(pattern => {
        let opt = document.createElement("option");
        opt.value = "custom_" + pattern.id;
        opt.text = pattern.name;
        dropdown.appendChild(opt);
      });
    }
    function updateCustomPatternsList() {
      let listDiv = document.getElementById("customPatternsList");
      listDiv.innerHTML = "";
      if(customPatterns.length === 0) {
        listDiv.innerHTML = "<p>لا توجد أنماط مخصصة.</p>";
      } else {
        customPatterns.forEach(pattern => {
          let div = document.createElement("div");
          div.className = "d-flex justify-content-between align-items-center mb-2";
          div.innerHTML = `
            <span>${pattern.name}: ${pattern.text}</span>
            <div>
              <button class="btn btn-sm btn-warning" onclick="editCustomPattern('${pattern.id}')">تعديل</button>
              <button class="btn btn-sm btn-danger" onclick="deleteCustomPattern('${pattern.id}')">حذف</button>
            </div>
          `;
          listDiv.appendChild(div);
        });
      }
    }
    function deleteCustomPattern(id) {
      customPatterns = customPatterns.filter(p => p.id !== id);
      saveCustomPatterns();
      updateCustomPatternsList();
      updateReasonModeDropdown();
    }
    function editCustomPattern(id) {
      let pattern = customPatterns.find(p => p.id === id);
      if(pattern) {
        document.getElementById("patternName").value = pattern.name;
        document.getElementById("patternText").value = pattern.text;
        editingPatternId = id;
        document.getElementById("addPatternBtn").textContent = "تعديل النمط";
      }
    }
    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById("addPatternBtn").addEventListener("click", function(){
        let name = document.getElementById("patternName").value.trim();
        let text = document.getElementById("patternText").value.trim();
        if(!name || !text) {
          alert("يرجى إدخال اسم النمط والنص.");
          return;
        }
        if(editingPatternId) {
          customPatterns = customPatterns.map(p => {
            if(p.id === editingPatternId) { return { id: p.id, name: name, text: text }; }
            return p;
          });
          editingPatternId = null;
          document.getElementById("addPatternBtn").textContent = "إضافة النمط";
        } else {
          let pattern = { id: Date.now().toString(), name: name, text: text };
          customPatterns.push(pattern);
        }
        saveCustomPatterns();
        updateCustomPatternsList();
        updateReasonModeDropdown();
        document.getElementById("patternName").value = "";
        document.getElementById("patternText").value = "";
      });
    });
    document.getElementById("reasonMode").addEventListener("change", function() {
      let selectedMode = this.value;
      let aiBox = document.getElementById("aiReasonBox");
      let manualBox = document.getElementById("manualReasonBox");
      if (selectedMode === "ai") {
        aiBox.style.display = "block";
        manualBox.style.display = "none";
        document.getElementById("aiReason").value = generateAIReason();
      } else if (selectedMode === "manual") {
        aiBox.style.display = "none";
        manualBox.style.display = "block";
      } else if (selectedMode.startsWith("custom_")) {
        let patternId = selectedMode.split("_")[1];
        let pattern = getCustomPatternById(patternId);
        if (pattern) {
          aiBox.style.display = "block";
          manualBox.style.display = "none";
          document.getElementById("aiReason").value = insertEmployeeName(pattern.text);
        }
      }
    });
    function getCustomPatternById(id) {
      return customPatterns.find(p => p.id === id);
    }
    function insertEmployeeName(patternText) {
      let name = document.getElementById("name").value.trim();
      return patternText.replace(/\bname\b/g, name || "الموظف");
    }
    let defaultAIRule = localStorage.getItem("defaultAIRule") || "تم توجيه {violationType} للموظف {name} نتيجة العمل الغير جدي، ولذلك تم تطبيق عقوبة قدرها 500 دج. نرجو منكم الإلتزام بالقوانين الخاصة بشركتنا لتجنب تكرار هذه المخالفات.";
    function saveAIRule() { localStorage.setItem("defaultAIRule", defaultAIRule); }
    document.getElementById("editAIRuleBtn").addEventListener("click", function() {
      document.getElementById("editAIRuleText").value = defaultAIRule;
      let modalElement = document.getElementById("editAIRuleModal");
      let modal = bootstrap.Modal.getInstance(modalElement);
      if(!modal) { modal = new bootstrap.Modal(modalElement); }
      modal.show();
    });
    document.getElementById("saveAIRuleChanges").addEventListener("click", function() {
      let newRule = document.getElementById("editAIRuleText").value.trim();
      if(newRule === "") { alert("يرجى إدخال نص نمط الذكاء الاصطناعي"); return; }
      defaultAIRule = newRule;
      saveAIRule();
      if(document.getElementById("reasonMode").value === "ai"){
        document.getElementById("aiReason").value = generateAIReason();
      }
      let modalElement = document.getElementById("editAIRuleModal");
      let modal = bootstrap.Modal.getInstance(modalElement);
      if(modal) { modal.hide(); }
    });
    function generateAIReason() {
      let name = document.getElementById("name").value.trim() || "الموظف";
      let typeSelect = document.getElementById("type");
      let violationTypeName = typeSelect ? typeSelect.options[typeSelect.selectedIndex].text : "إنذار";
      let ruleText = defaultAIRule.replace("{violationType}", violationTypeName).replace("{name}", name);
      return ruleText;
    }
    document.getElementById("name").addEventListener("input", function() {
      let selectedMode = document.getElementById("reasonMode").value;
      if (selectedMode.startsWith("custom_")) {
        let patternId = selectedMode.split("_")[1];
        let pattern = getCustomPatternById(patternId);
        if (pattern) {
          document.getElementById("aiReason").value = insertEmployeeName(pattern.text);
        }
      }
    });
    /****************************************
     * قسم إدارة التنبيهات         *
     ****************************************/
    const addBtn = document.getElementById("add-btn");
    const nameInput = document.getElementById("name");
    const alertsList = document.getElementById("alerts-list");
    const searchInput = document.getElementById("search-input");
    const filterTypeSelect = document.getElementById("filter-type");
    const typeNumberInput = document.getElementById("typeNumber");
    const ALERTS_STORAGE_KEY = 'alertsData';
    let alerts = [];
    let editingIndex = -1;
    function attachListEventListeners() {
      document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', function() {
          const index = this.getAttribute('data-index');
          editAlert(index);
        });
      });
      document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function() {
          const index = this.getAttribute('data-index');
          deleteAlert(index);
        });
      });
      document.querySelectorAll('.print-btn').forEach(button => {
        button.addEventListener('click', function() {
          const index = this.getAttribute('data-index');
          printAlert(alerts[index]);
        });
      });
    }
    function saveAlertsToLocalStorage() {
      localStorage.setItem(ALERTS_STORAGE_KEY, JSON.stringify(alerts));
    }
    function loadAlertsFromLocalStorage() {
      const storedAlerts = localStorage.getItem(ALERTS_STORAGE_KEY);
      if (storedAlerts) { alerts = JSON.parse(storedAlerts); }
    }
    function addAlert() {
      const name = nameInput.value.trim();
      let selectedMode = document.getElementById("reasonMode").value;
      let finalReason = "";
      if (selectedMode === "ai") {
        finalReason = document.getElementById("aiReason").value.trim();
      } else if (selectedMode === "manual") {
        finalReason = document.getElementById("manualReason").value.trim();
      } else if (selectedMode.startsWith("custom_")) {
        finalReason = document.getElementById("aiReason").value.trim();
      }
      if(name === "") {
        alert("الرجاء ملء جميع الحقول (اسم الموظف).");
        return;
      }
      if(selectedMode === "manual" && finalReason === "") {
        alert("الرجاء ملء جميع الحقول (سبب الإنذار).");
        return;
      }
      const type = document.getElementById("type").value;
      const typeNumber = typeNumberInput.value.trim();
      const today = new Date();
      const date = today.toLocaleDateString('fr-CA');
      const [year, month, day] = date.split('-');
      const formattedDate = [day, month, year].join('/');
      const alertObj = { name: name, reason: finalReason, type: type, date: formattedDate, typeNumber: typeNumber };
      if(editingIndex !== -1) {
        alerts[editingIndex] = alertObj;
        editingIndex = -1;
      } else {
        alerts.unshift(alertObj);
      }
      saveAlertsToLocalStorage();
      updateAlertsModalList();
      // فتح مودال النجاح بعد الإضافة
      let successModal = new bootstrap.Modal(document.getElementById("successModal"));
      successModal.show();
      nameInput.value = "";
      document.getElementById("aiReason").value = "";
      document.getElementById("manualReason").value = "";
      typeNumberInput.value = "";
    }
    function deleteAlert(index) {
      alerts.splice(index, 1);
      updateAlertsModalList();
      saveAlertsToLocalStorage();
    }
    function editAlert(index) {
      editingIndex = index;
      const alertObj = alerts[index];
      nameInput.value = alertObj.name;
      document.getElementById("type").value = alertObj.type;
      typeNumberInput.value = alertObj.typeNumber;
      document.getElementById("reasonMode").value = "manual";
      document.getElementById("aiReason").value = "";
      document.getElementById("aiReasonBox").style.display = "none";
      document.getElementById("manualReasonBox").style.display = "block";
      document.getElementById("manualReason").value = alertObj.reason;
    }
    function printAlert(alertObj) {
      const printWindow = window.open('', '', 'width=600,height=600');
      let vt = violationTypes.find(v => v.id === alertObj.type);
      let violationName = vt ? vt.name : alertObj.type;
      let titleClassType = "print-title-penalty";
      if(vt && vt.name === "مكافأة") { titleClassType = "print-title-success"; }
      const generatePrintContent = () => {
        return `
          <div class="print-area">
            <h2 class="print-title">
              <span class="${titleClassType}">
                ${violationName} ${alertObj.typeNumber ? '(' + alertObj.typeNumber + ')' : ''}
              </span>
            </h2>
            <p class="print-alert-message">
              ${alertObj.reason}
            </p>
            <p class="print-date">التاريخ: ${alertObj.date}</p>
            <div class="signature">إمضاء</div>
          </div>
        `;
      };
      printWindow.document.write(`
        <html>
          <head>
            <title>طباعة</title>
            <style>
              body { font-family: 'Tajawal', sans-serif; direction: rtl; }
              @media print {
                .print-area { padding: 30px; border: 3px solid #000; margin: 15px; position: relative; min-height: 250px; } /* Updated print area styles */
                .signature { position: absolute; bottom: 55px; left: 30px; width: 250px; text-align: center; font-size: 1.7em; line-height: 1.7; border: none; } /* Updated signature styles */
                .print-title { text-align: center; font-size: 2em; margin-bottom: 15px; } /* Updated title font size and margin */
                .print-alert-message { text-align: center; font-size: 1.7em; line-height: 1.7; margin-bottom: 15px; } /* Updated message font size, line height, and added text-align */
                .print-date { font-size: 1.4em; line-height: 1.6; } /* Updated date font size and line height */
                .print-title-penalty { color: red !important; }
                .print-title-success { color: green !important; }
              }
            </style>
          </head>
          <body>
            ${generatePrintContent()}
            <hr style="border: 1px dashed #000; margin: 20px 0;">
            ${generatePrintContent()}
          </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
      printWindow.close();
    }
    function updateAlertsModalList() {
      let modalList = document.getElementById("alertsModalList");
      modalList.innerHTML = "";
      // قراءة قيمة البحث من حقل داخل المودال
      let searchValue = document.getElementById("modalSearchInput").value.trim().toLowerCase();
      let filteredAlerts = alerts.filter(alertObj => alertObj.name.toLowerCase().includes(searchValue));
      filteredAlerts.forEach((alertObj, index) => {
        let li = document.createElement("li");
        li.className = "alert-item d-flex justify-content-between align-items-center";
        li.innerHTML = `
          <span>
            <span class="alert-type">
              ${(violationTypes.find(v => v.id === alertObj.type) || {}).name || alertObj.type}
              ${alertObj.typeNumber ? '(' + alertObj.typeNumber + ')' : ''}
            </span>:
            ${alertObj.name} - ${alertObj.reason} (${alertObj.date})
          </span>
          <div>
            <button class="btn btn-sm btn-primary me-1 edit-btn" data-index="${index}">
              <i class="fas fa-edit"></i> تعديل
            </button>
            <button class="btn btn-sm btn-info me-1 print-btn" data-index="${index}">
              <i class="fas fa-print"></i> طباعة
            </button>
            <button class="btn btn-sm btn-danger delete-btn" data-index="${index}">
              <i class="fas fa-trash"></i> حذف
            </button>
          </div>
        `;
        modalList.appendChild(li);
      });
      document.querySelectorAll("#alertsModalList .edit-btn").forEach(button => {
        button.addEventListener("click", function() {
          const index = this.getAttribute("data-index");
          editAlert(index);
          let modal = bootstrap.Modal.getInstance(document.getElementById("alertsModal"));
          if(modal) modal.hide();
        });
      });
      document.querySelectorAll("#alertsModalList .delete-btn").forEach(button => {
        button.addEventListener("click", function() {
          const index = this.getAttribute("data-index");
          deleteAlert(index);
          updateAlertsModalList();
        });
      });
      document.querySelectorAll("#alertsModalList .print-btn").forEach(button => {
        button.addEventListener("click", function() {
          const index = this.getAttribute("data-index");
          printAlert(alerts[index]);
        });
      });
    }
    function attachMainListeners() {
      if(!window.mainListenersAttached){
        addBtn.addEventListener("click", function() { addAlert(); });
        window.mainListenersAttached = true;
      }
    }
    function goToApp() {
      document.getElementById("welcomeScreen").style.display = "none";
      document.getElementById("app-container").style.display = "block";
      attachMainListeners();
      loadAlertsFromLocalStorage();
      updateAlertsModalList();
    }
    document.getElementById("backToMenuBtn").addEventListener("click", function() {
      document.getElementById("app-container").style.display = "none";
      document.getElementById("welcomeScreen").style.display = "flex";
    });
    document.getElementById("showAlertsBtn").addEventListener("click", function() {
      updateAlertsModalList();
      let modal = new bootstrap.Modal(document.getElementById("alertsModal"));
      modal.show();
    });
    document.getElementById("printAlertsBtn").addEventListener("click", function() {
      if(alerts.length > 0) { printAlert(alerts[0]); }
      else { alert("لا توجد تنبيهات للطباعة."); }
    });
    document.getElementById("printSuccessBtn").addEventListener("click", function() {
      if(alerts.length > 0) { printAlert(alerts[0]); }
      else { alert("لا توجد تنبيهات للطباعة."); }
    });
    document.getElementById("backupBtn")?.addEventListener("click", function() {
      let backupData = {
        alerts: localStorage.getItem(ALERTS_STORAGE_KEY),
        customPatterns: localStorage.getItem("customPatterns"),
        violationTypes: localStorage.getItem("violationTypes"),
        employeeNames: localStorage.getItem("employeeNames"),
        defaultAIRule: localStorage.getItem("defaultAIRule")
      };
      let dataStr = JSON.stringify(backupData, null, 2);
      let blob = new Blob([dataStr], { type: "application/json" });
      let url = URL.createObjectURL(blob);
      let a = document.createElement("a");
      a.href = url;
      a.download = "backupData.json";
      a.click();
      URL.revokeObjectURL(url);
    });
    document.getElementById("restoreBtn")?.addEventListener("click", function() {
      document.getElementById("restoreFileInput").click();
    });
    document.getElementById("restoreFileInput").addEventListener("change", function(event) {
      let file = event.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = function(e) {
        try {
          let backupData = JSON.parse(e.target.result);
          if (backupData.alerts) { localStorage.setItem(ALERTS_STORAGE_KEY, backupData.alerts); }
          if (backupData.customPatterns) { localStorage.setItem("customPatterns", backupData.customPatterns); }
          if (backupData.violationTypes) { localStorage.setItem("violationTypes", backupData.violationTypes); }
          if (backupData.employeeNames) { localStorage.setItem("employeeNames", backupData.employeeNames); }
          if (backupData.defaultAIRule) { localStorage.setItem("defaultAIRule", backupData.defaultAIRule); }
          loadAlertsFromLocalStorage();
          loadCustomPatterns();
          updateCustomPatternsList();
          updateReasonModeDropdown();
          updateAlertsModalList();
          loadViolationTypes();
          updateViolationTypesList();
          updateViolationTypeDropdown();
          loadEmployeeNames();
          updateEmployeeDatalist();
          updateEmployeeList();
          defaultAIRule = localStorage.getItem("defaultAIRule") || defaultAIRule;
          alert("تم استرجاع البيانات بنجاح.");
        } catch (err) {
          alert("خطأ في قراءة ملف النسخة الاحتياطية.");
        }
      };
      reader.readAsText(file);
    });
    (function createRestoreInput() {
      if (!document.getElementById("restoreFileInput")) {
        let input = document.createElement("input");
        input.type = "file";
        input.id = "restoreFileInput";
        input.style.display = "none";
        input.accept = ".json";
        document.body.appendChild(input);
      }
    })();
    /****************************************
     * قسم إدارة أنواع المخالفات     *
     ****************************************/
    let violationTypes = [];
    function loadViolationTypes() {
      let data = localStorage.getItem("violationTypes");
      if (data) { violationTypes = JSON.parse(data); }
      else { violationTypes = [{ id: "warning", name: "إنذار" }]; }
    }
    function saveViolationTypes() {
      localStorage.setItem("violationTypes", JSON.stringify(violationTypes));
    }
    function updateViolationTypeDropdown() {
      let typeSelect = document.getElementById("type");
      if (typeSelect) {
        typeSelect.innerHTML = "";
        violationTypes.forEach(vt => {
          let option = document.createElement("option");
          option.value = vt.id;
          option.text = vt.name;
          typeSelect.appendChild(option);
        });
      }
    }
    function updateViolationTypesList() {
      let listDiv = document.getElementById("violationTypesList");
      listDiv.innerHTML = "";
      violationTypes.forEach(vt => {
        let div = document.createElement("div");
        div.className = "d-flex justify-content-between align-items-center mb-2";
        div.innerHTML = `
          <span>${vt.name}</span>
          <button class="btn btn-sm btn-danger" onclick="deleteViolationType('${vt.id}')">حذف</button>
        `;
        listDiv.appendChild(div);
      });
    }
    document.getElementById("addViolationTypeBtn").addEventListener("click", function(){
      let newType = document.getElementById("newViolationType").value.trim();
      if (!newType) { alert("يرجى إدخال اسم نوع المخالفة"); return; }
      let id = Date.now().toString();
      violationTypes.push({ id, name: newType });
      saveViolationTypes();
      updateViolationTypesList();
      updateViolationTypeDropdown();
      document.getElementById("newViolationType").value = "";
    });
    function deleteViolationType(id) {
      violationTypes = violationTypes.filter(vt => vt.id !== id);
      saveViolationTypes();
      updateViolationTypesList();
      updateViolationTypeDropdown();
    }
    /****************************************
     * قسم إدارة الموظفين          *
     ****************************************/
    let employeeNames = [];
    function loadEmployeeNames() {
      let data = localStorage.getItem("employeeNames");
      employeeNames = data ? JSON.parse(data) : [];
    }
    function saveEmployeeNames() {
      localStorage.setItem("employeeNames", JSON.stringify(employeeNames));
    }
    function updateEmployeeDatalist() {
      let datalist = document.getElementById("employeeList");
      datalist.innerHTML = "";
      employeeNames.forEach(name => {
        let option = document.createElement("option");
        option.value = name;
        datalist.appendChild(option);
      });
    }
    function updateEmployeeList() {
      let listDiv = document.getElementById("employeeListDiv");
      listDiv.innerHTML = "";
      employeeNames.forEach((name, index) => {
        let div = document.createElement("div");
        div.className = "d-flex justify-content-between align-items-center mb-2";
        div.innerHTML = `<span>${name}</span><button class="btn btn-sm btn-danger" onclick="deleteEmployee(${index})">حذف</button>`;
        listDiv.appendChild(div);
      });
    }
    function addEmployee() {
      let newName = document.getElementById("newEmployeeName").value.trim();
      if(newName === "") { alert("يرجى إدخال اسم الموظف"); return; }
      employeeNames.push(newName);
      saveEmployeeNames();
      updateEmployeeDatalist();
      updateEmployeeList();
      document.getElementById("newEmployeeName").value = "";
    }
    function deleteEmployee(index) {
      employeeNames.splice(index, 1);
      saveEmployeeNames();
      updateEmployeeDatalist();
      updateEmployeeList();
    }
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById("welcomeScreen").style.display = "flex";
      document.getElementById("app-container").style.display = "none";
      loadCustomPatterns();
      updateCustomPatternsList();
      updateReasonModeDropdown();
      loadViolationTypes();
      updateViolationTypesList();
      updateViolationTypeDropdown();
      loadEmployeeNames();
      updateEmployeeDatalist();
      updateEmployeeList();
      attachMainListeners();
    });
    document.getElementById("addEmployeeBtn").addEventListener("click", addEmployee);
  </script>
</body>
</html>
